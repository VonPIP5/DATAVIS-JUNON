<!DOCTYPE html>
<html>
<head>
    <title>Visualisation 3D - Nappe Phreatique</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <a-scene>
        <!-- Mur -->
        <a-entity id="mur">
            <!-- Mur 1 (Face avant) -->
            <a-plane position="0 2.355 -5.2" rotation="0 0 0" width="6.93" height="4.75" shadow="cast:true; receive:true" static-body
            material="src: ./textures/texture-mur.jpg; roughness: 1; metalness: 0; repeat: 3 1;"></a-plane>
            
            <!-- Mur 2 (Avant-droite) -->
            <a-plane position="4.5 2.355 -2.6" rotation="0 -60 0" width="6.93" height="4.75" shadow="cast:true; receive:true" static-body
            material="src: ./textures/texture-mur.jpg; roughness: 1; metalness: 0; repeat: 3 1;"></a-plane>
            
            <!-- Mur 3 (Arriere-droite) -->
            <a-plane position="4.5 2.355 2.6" rotation="0 -120 0" width="6.93" height="4.75" shadow="cast:true; receive:true" static-body
            material="src: ./textures/texture-mur.jpg; roughness: 1; metalness: 0; repeat: 3 1;"></a-plane>
            
            <!-- Mur 4 (Face arriere) -->
            <a-plane position="0 2.355 5.2" rotation="0 180 0" width="6.93" height="4.75" shadow="cast:true; receive:true" static-body
            material="src: ./textures/texture-mur.jpg; roughness: 1; metalness: 0; repeat: 3 1;"></a-plane>
            
            <!-- Mur 5 (Arriere-gauche) -->
            <a-plane position="-4.5 2.355 2.6" rotation="0 120 0" width="6.93" height="4.75" shadow="cast:true; receive:true" static-body
            material="src: ./textures/texture-mur.jpg; roughness: 1; metalness: 0; repeat: 3 1;"></a-plane>
            
            <!-- Mur 6 (Avant-gauche) -->
            <a-plane position="-4.5 2.355 -2.6" rotation="0 60 0" width="6.93" height="4.75" shadow="cast:true; receive:true" static-body
            material="src: ./textures/texture-mur.jpg; roughness: 1; metalness: 0; repeat: 3 1;"></a-plane>
        </a-entity>
        
        <!-- Plafond -->
        <a-entity id="plafond">
            <a-circle position="0 4.75 0" rotation="90 0 0" radius="7" 
                material="src: ./textures/metal_black1k.jpg; color: #696969; roughness: 1; metalness: 0; repeat: 3 3; emissive: #000000; emissiveIntensity: 3;">
            </a-circle>
            <a-entity id="lumNappesToit" light="type: spot; color: #FFFFFF; intensity: 0.9; castShadow: true; angle: 35; penumbra: 0.7" position="0 4.7 0" rotation="-90 0 0"></a-entity>
            <a-entity id="lumNappesSol" light="type: spot; color: #FFFFFF; intensity: 0.9; castShadow: true; angle: 35; penumbra: 0.7" position="0 -0.125 0" rotation="90 0 0"></a-entity>
        </a-entity>

        <!-- Sol -->
        <a-circle id="sol" position="0 0 0" radius="7" rotation="-90 0 0"
            material="src: ./textures/test-sol.jpg; color: #696969; roughness: 1; metalness: 0; repeat: 8 8;" static-body segments-radial="6">
        </a-circle>

        <!-- Plinthes bas -->
        <a-entity id="plinthes-Bas">
            <!-- Face avant -->
            <a-box position="0 0 -5.2" rotation="0 0 0" width="6.93" height="0.02" depth="0.1" 
            material="color: white; emissive: #0035ff ; emissiveIntensity: 0.6"></a-box>
        
            <!-- Avant-droite -->
            <a-box position="4.5 0 -2.6" rotation="0 -60 0" width="6.93" height="0.02" depth="0.1" 
            material="color: white; emissive: #0035ff ; emissiveIntensity: 0.6"></a-box>
        
            <!-- Arriere-droite -->
            <a-box position="4.5 0 2.6" rotation="0 -120 0" width="6.93" height="0.02" depth="0.1" 
            material="color: white; emissive: #0035ff ; emissiveIntensity: 0.6"></a-box>
        
            <!-- Face arriere -->
            <a-box position="0 0 5.2" rotation="0 180 0" width="6.93" height="0.02" depth="0.1" 
            material="color: white; emissive: #0035ff ; emissiveIntensity: 0.6"></a-box>
        
            <!-- Arriere-gauche -->
            <a-box position="-4.5 0 2.6" rotation="0 120 0" width="6.93" height="0.02" depth="0.1" 
            material="color: white; emissive: #0035ff ; emissiveIntensity: 0.6"></a-box>
        
            <!-- Avant-gauche -->
            <a-box position="-4.5 0 -2.6" rotation="0 60 0" width="6.93" height="0.02" depth="0.1" 
            material="color: white; emissive: #0035ff ; emissiveIntensity: 0.6"></a-box>
        </a-entity>    
        
        <!-- Plinthes haut -->
        <a-entity id="plinthes-Haut">
            <!-- Face avant -->
            <a-box position="0 4.75 -5.2" rotation="0 0 0" width="6.93" height="0.02" depth="0.1" 
            material="color: white; emissive: #0035ff ; emissiveIntensity: 0.6"></a-box>
        
            <!-- Avant-droite -->
            <a-box position="4.5 4.75 -2.6" rotation="0 -60 0" width="6.93" height="0.02" depth="0.1" 
            material="color: white; emissive: #0035ff ; emissiveIntensity: 0.6"></a-box>
        
            <!-- Arriere-droite -->
            <a-box position="4.5 4.75 2.6" rotation="0 -120 0" width="6.93" height="0.02" depth="0.1" 
            material="color: white; emissive: #0035ff ; emissiveIntensity: 0.6"></a-box>
        
            <!-- Face arriere -->
            <a-box position="0 4.75 5.2" rotation="0 180 0" width="6.93" height="0.02" depth="0.1" 
            material="color: white; emissive: #0035ff ; emissiveIntensity: 0.6"></a-box>
        
            <!-- Arriere-gauche -->
            <a-box position="-4.5 4.75 2.6" rotation="0 120 0" width="6.93" height="0.02" depth="0.1" 
            material="color: white; emissive: #0035ff ; emissiveIntensity: 0.6"></a-box>
        
            <!-- Avant-gauche -->
            <a-box position="-4.5 4.75 -2.6" rotation="0 60 0" width="6.93" height="0.02" depth="0.1" 
            material="color: white; emissive: #0035ff ; emissiveIntensity: 0.6"></a-box>
        </a-entity>  

        <!-- profondeur terre -->
        <a-entity geometry="primitive: cylinder; radius: 2.505; height: 3; segmentsRadial: 6"
                id="water"
                material="color: #692f0b; emissive: #692f0b; emissiveIntensity: 0.3" 
                position="0 0 0" rotation="180 30 0" shadow="cast:true; receive:true" static-body>
        </a-entity>

        <!-- Nappe phreatique -->
        <a-entity geometry="primitive: cylinder; radius: 2.5; height: 1.5; segmentsRadial: 6"
            material="color: #1E88E5; emissive: #1E88E5; emissiveIntensity: 0.3"
            position="0 0.75 0"
            rotation="0 30 0"
            shadow="cast:true; receive:true">
        </a-entity>

        <!-- Panneau de graphique -->
        <a-entity id="chartPanel" position="4.45 2.4 -2.6" rotation="0 -60 0">
            <a-plane id="chartPlane" width="4" height="3" material="color: white">
            </a-plane>
        </a-entity>

        <!-- Panneau d'information principal -->
        <a-entity id="infoPanel" position="-4.5 2.5 -2.5" rotation="0 60 0">
            <a-plane width="3.35" height="3.8" color="#333" opacity="0.8">
                <a-text id="infoText" value="Chargement..." 
                        width="2.7" align="left" wrap-count="25"
                        position="-1.3 0 0" color="white"
                        font="https://raw.githubusercontent.com/VonPIP5/DATAVIS-JUNON/refs/heads/Partie-Ma%C3%ABl/custom-font-a-Frame/custom-a-frame.fnt"></a-text>
            </a-plane>
        </a-entity>

        <!-- Panneau meteo -->
        <a-entity id="meteoPanel" position="4.5 2.5 2.5" rotation="0 -120 0">
            <a-plane width="2.4" height="3.5" color="#333" opacity="0.8">
                <a-text id="meteoText" value="Chargement meteo..." 
                        width="2.7" align="left" wrap-count="25"
                        position="-1 0 0" color="white"
                        font="https://raw.githubusercontent.com/VonPIP5/DATAVIS-JUNON/refs/heads/Partie-Ma%C3%ABl/custom-font-a-Frame/custom-a-frame.fnt"></a-text>
            </a-plane>
        </a-entity>

        <!-- Panneau statistiques -->
        <a-entity id="statsPanel" position="0 2.5 5.1" rotation="0 180 0">
            <a-plane width="2.5" height="3.3" color="#333" opacity="0.8">
                <a-text id="statsText" value="Chargement stats..." 
                        width="2.7" align="left" wrap-count="30"
                        position="-1 0 0" color="white"
                        font="https://raw.githubusercontent.com/VonPIP5/DATAVIS-JUNON/refs/heads/Partie-Ma%C3%ABl/custom-font-a-Frame/custom-a-frame.fnt"></a-text>
            </a-plane>
        </a-entity>

        <!-- Affichage niveau d'eau -->
        <a-entity id="waterLevelDisplay" position="0 4.5 0" rotation="0 180 0">
            <a-plane position="0 -0.1 0.1" rotation="0 0 0" width="2.1" height="0.5"
                material="color: #f5f5f5; opacity: 0.7; emissive: #f5f5f5; emissiveIntensity: 0.3" ></a-plane>
            <a-box width="2.3" height="1" depth="0.1" color="#000000">
                <a-text id="waterLevelText" value="" 
                        width="3" align="center"
                        position="0 -0.1 0.11" color="white"
                        font="https://raw.githubusercontent.com/VonPIP5/DATAVIS-JUNON/refs/heads/Partie-Ma%C3%ABl/custom-font-a-Frame/custom-a-frame.fnt"></a-text>
            </a-box>
        </a-entity>

        <!-- Camera -->
        <a-entity position="0 0.2 -4.5" rotation="0 180 0">
            <a-camera raycaster="objects: .interactive" far="12" id="camera" fov="100" 
                look-controls="pointerLockEnabled: true; mouseDrag: true" wasd-controls="enabled: true" rotation="0 0 0">
                <a-plane id="cursor"
                        position="0 0 -1"
                        width="0.12" 
                        height="0.12" 
                        material="src: ./textures/cursor.png; transparent: true; roughness: 100; metalness: 0;">
                </a-plane>
            </a-camera>
        </a-entity>

        <!-- Lumiere ambiante-->
        <a-light type="ambient" color="#8899FF" intensity="0.2"></a-light>

        <!-- Ciel -->
        <a-sky color="#ECECEC"></a-sky>
    </a-scene>

    <script>
        // Récupération des données depuis le sessionStorage
        const stationData = JSON.parse(sessionStorage.getItem('waterData'));
        const apiBaseUrl = "https://hubeau.eaufrance.fr/api/v1/niveaux_nappes";
        
        // Objet pour stocker toutes les données
        const waterData = {
            stationInfo: stationData.stationInfo,
            waterLevels: [],
            lastMeasurement: null,
            meteoData: null,
            statistics: null
        };

        // Fonction pour convertir le format de date DD-MM-YYYY en YYYY-MM-DD
        function convertToAPIDateFormat(dateStr) {
            const [day, month, year] = dateStr.split('-');
            return `${year}-${month}-${day}`;
        }

        // Fonction pour formater le texte avec saut de ligne
        function formatText(content) {
            return content.replace(/<br>/g, '\n');
        }

        // Fonction pour récupérer les données de niveau d'eau
        async function fetchWaterLevels() {
            try {
                const dateDebutAPI = convertToAPIDateFormat(waterData.stationInfo.dateDebut);
                const dateFinAPI = convertToAPIDateFormat(waterData.stationInfo.dateFin);
                
                const response = await fetch(
                    `${apiBaseUrl}/chroniques?code_bss=${waterData.stationInfo.codeBss}&date_debut_mesure=${dateDebutAPI}&date_fin_mesure=${dateFinAPI}`
                );
                const data = await response.json();
                
                if (data.data && data.data.length > 0) {
                    waterData.waterLevels = data.data.map(item => ({
                        value: item.niveau_nappe_eau,
                        date: new Date(item.date_mesure).toLocaleDateString(),
                        profondeur: item.profondeur_nappe
                    }));
                    
                    waterData.lastMeasurement = waterData.waterLevels[waterData.waterLevels.length - 1];
                    
                    // Calcul des statistiques
                    calculateStatistics();
                }
            } catch (error) {
                console.error("Erreur lors de la récupération des niveaux d'eau:", error);
            }
        }

        // Fonction pour récupérer les données météo
        async function fetchMeteoData() {
            try {
                const { lat, lng } = waterData.stationInfo.coordinates;
                const dateDebutAPI = convertToAPIDateFormat(waterData.stationInfo.dateDebut);
                const dateFinAPI = convertToAPIDateFormat(waterData.stationInfo.dateFin);
                
                const url = `https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lng}&start_date=${dateDebutAPI}&end_date=${dateFinAPI}&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,weather_code`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.daily) {
                    waterData.meteoData = {
                        tempMax: data.daily.temperature_2m_max,
                        tempMin: data.daily.temperature_2m_min,
                        precipitation: data.daily.precipitation_sum,
                        weatherCode: data.daily.weather_code,
                        dates: data.daily.time.map(date => new Date(date).toLocaleDateString()
                    )};
                }
            } catch (error) {
                console.error("Erreur lors de la récupération des données météo:", error);
            }
        }

        // Fonction pour calculer les statistiques
        function calculateStatistics() {
            const values = waterData.waterLevels.map(item => item.value).sort((a, b) => a - b);
            const n = values.length;
            
            if (n > 0) {
                waterData.statistics = {
                    current: {
                        median: calculatePercentile(values, 50),
                        q1: calculatePercentile(values, 25),
                        q3: calculatePercentile(values, 75),
                        min: values[0],
                        max: values[values.length - 1]
                    }
                };
            }
        }

        function calculatePercentile(values, percentile) {
            const index = (percentile / 100) * (values.length - 1);
            if (Math.floor(index) === index) {
                return values[index];
            }
            const i = Math.floor(index);
            const fraction = index - i;
            return values[i] + (values[i + 1] - values[i]) * fraction;
        }

        // Mise à jour des panneaux 3D
        function updatePanels() {
            // Panneau principal
            const infoContent = `
                ${waterData.stationInfo.commune}<br>
                Département: ${waterData.stationInfo.departement}<br>
                Code BSS: ${waterData.stationInfo.codeBss}<br>
                Altitude: ${waterData.stationInfo.altitude} m<br>
                Profondeur Investigation: ${waterData.stationInfo.profondeurInv} m<br>
                ${waterData.lastMeasurement ? `Profondeur actuelle: ${waterData.lastMeasurement.profondeur.toFixed(2)} m<br>` : ''}
                Période: ${waterData.stationInfo.dateDebut} au ${waterData.stationInfo.dateFin}
            `;
            document.querySelector('#infoText').setAttribute('value', formatText(infoContent));

            // Panneau meteo
            if (waterData.meteoData) {
                const avgTempMax = (waterData.meteoData.tempMax.reduce((a, b) => a + b, 0) / waterData.meteoData.tempMax.length).toFixed(1);
                const avgTempMin = (waterData.meteoData.tempMin.reduce((a, b) => a + b, 0) / waterData.meteoData.tempMin.length).toFixed(1);
                const totalPrecip = waterData.meteoData.precipitation.reduce((a, b) => a + b, 0).toFixed(1);
                
                const meteoContent = `
                    Données météo<br>
                    (Moyenne sur la période)<br>
                    Temp. max: ${avgTempMax}°C<br>
                    Temp. min: ${avgTempMin}°C<br>
                    Précipitations: ${totalPrecip} mm<br>
                    Période: ${waterData.meteoData.dates[0]}<br>
                    à ${waterData.meteoData.dates[waterData.meteoData.dates.length-1]}
                `;
                document.querySelector('#meteoText').setAttribute('value', formatText(meteoContent));
            }

            // Panneau stats
            if (waterData.statistics) {
                const statsContent = `
                    Statistiques du niveau d'eau<br>
                    Période: ${waterData.stationInfo.dateDebut}<br>
                    au ${waterData.stationInfo.dateFin}<br>
                    Médiane: ${waterData.statistics.current.median.toFixed(2)} m<br>
                    Quartile 1: ${waterData.statistics.current.q1.toFixed(2)} m<br>
                    Quartile 3: ${waterData.statistics.current.q3.toFixed(2)} m<br>
                    Minimum: ${waterData.statistics.current.min.toFixed(2)} m<br>
                    Maximum: ${waterData.statistics.current.max.toFixed(2)} m
                `;
                document.querySelector('#statsText').setAttribute('value', formatText(statsContent));
            }
        }

        function setupWater() {
            const waterElement = document.querySelector('#water');
            if (!waterData.lastMeasurement) return;

            const values = waterData.waterLevels.map(item => item.value);
            const minValue = waterData.statistics.current.min;
            const maxValue = waterData.statistics.current.max;
            
            const waterLevelContent = `Niveau: ${waterData.lastMeasurement.value.toFixed(2)} m\n(Min: ${minValue.toFixed(2)} m / Max: ${maxValue.toFixed(2)} m)`;
            document.querySelector('#waterLevelText').setAttribute('value', waterLevelContent);

            const maxDepthVisual = 3;
            const scaledHeight = (waterData.lastMeasurement.profondeur / waterData.stationInfo.altitude) * maxDepthVisual;
            const waterY = (1.5 + 0.01) - scaledHeight / 2;

            waterElement.setAttribute('geometry', {
                primitive: 'cylinder',
                radius: 2.505,
                height: scaledHeight,
                segmentsRadial: 6
            });

            waterElement.setAttribute('position', `0 ${waterY} 0`);
        }

        async function createChart() {
            const canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 600;
            const ctx = canvas.getContext('2d');

            const labels = waterData.waterLevels.map(item => item.date);
            const chartValues = waterData.waterLevels.map(item => item.value);

            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Niveau de la nappe (m)',
                        data: chartValues,
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    animation: {
                        onComplete: () => {
                            const chartImgDataUrl = canvas.toDataURL("image/png");
                            const chartPlane = document.querySelector('#chartPlane');
                            chartPlane.setAttribute('material', 'src', chartImgDataUrl);
                        }
                    },
                    responsive: false,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Évolution du niveau d'eau - ${waterData.stationInfo.commune} (${waterData.stationInfo.dateDebut} au ${waterData.stationInfo.dateFin})`
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Niveau: ${context.parsed.y.toFixed(2)} m`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Niveau (m)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        }
                    }
                }
            });
        }

        // Chargement initial
        document.addEventListener('DOMContentLoaded', async function () {
            try {
                await Promise.all([
                    fetchWaterLevels(),
                    fetchMeteoData()
                ]);
                
                updatePanels();
                setupWater();
                createChart();
            } catch (error) {
                console.error("Erreur lors du chargement des données:", error);
            }
        });
    </script>
</body>
</html>