<!DOCTYPE html>
<html>
<head>
    <title>Visualisation 3D - Nappe Phréatique</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <style>
        .info-panel {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 1000;
            max-width: 300px;
            font-family: Arial, sans-serif;
        }
        .water-level {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 100, 200, 0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            z-index: 1000;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <a-scene>
        <!-- Mur arrière -->
        <a-box material="src: ./textures/tapisserie.avif; roughness: 1; metalness: 0; repeat: 15 5;" 
            shadow="cast:true; receive:true" position="0 2.355 -7.5" 
            height="4.75" depth="0.5" width="15" static-body>
            <a-box material="src: ./textures/boiserie.jpg; repeat: 15 1;" 
                shadow="cast:true; receive:true" position="0 -1.74 0.05" 
                height="1.25" depth="0.5" width="15" static-body></a-box>
        </a-box>

        <!-- Mur avant -->
        <a-box material="src: ./textures/tapisserie.avif; roughness: 1; metalness: 0; repeat: 15 5;" 
            shadow="cast:true; receive:true" position="0 2.355 7.5" 
            height="4.75" depth="0.5" width="15" static-body>
            <a-box material="src: ./textures/boiserie.jpg; repeat: 15 1;" 
                shadow="cast:true; receive:true" position="0 -1.74 -0.05" 
                height="1.25" depth="0.5" width="15" static-body></a-box>
        </a-box>

        <!-- Mur gauche -->
        <a-box material="src: ./textures/tapisserie.avif; roughness: 1; metalness: 0; repeat: 15 5;" 
            shadow="cast:true; receive:true" position="-7.5 2.355 0" 
            height="4.75" depth="15" width="0.5" static-body>
            <a-box material="src: ./textures/boiserie.jpg; repeat: 15 1;" 
                shadow="cast:true; receive:true" position="0.05 -1.74 0" 
                height="1.25" depth="15" width="0.5" static-body></a-box>
        </a-box>

        <!-- Mur droit -->
        <a-box material="src: ./textures/tapisserie.avif; roughness: 1; metalness: 0; repeat: 15 5;" 
            shadow="cast:true; receive:true" position="7.5 2.355 0" 
            height="4.75" depth="15" width="0.5" static-body>
            <a-box material="src: ./textures/boiserie.jpg; repeat: 15 1;" 
                shadow="cast:true; receive:true" position="-0.05 -1.74 0" 
                height="1.25" depth="15" width="0.5" static-body></a-box>
        </a-box>

        <!-- Plafond -->
        <a-plane position="0 4.75 0" rotation="90 0 0" width="15" height="15" 
            material="src: ./textures/plank.jpg; color: #696969; roughness: 1; metalness: 0; repeat: 15 15;">
        </a-plane>

        <!-- Sol -->
        <a-box shadow="receive:true" position="0 -1 0" width="15" height="2" depth="15"
            material="src: ./textures/plank.jpg; color: #696969; roughness: 1; metalness: 0; repeat: 15 15;"
            static-body></a-box>

        <!-- Ciel -->
        <a-sky color="#ECECEC"></a-sky>

        <!-- Nappe phréatique -->
        <a-box id="water" width="5" depth="0.5" color="#1E88E5" opacity="0.8" 
               position="0 0.25 -6.75"></a-box>

        <!-- Échelle de mesure -->
        <a-cylinder radius="0.05" height="3" color="red" position="0 1.5dz -6.75" ></a-cylinder>

        <!-- Lumière -->
        <a-light type="ambient" color="#FFFFFF"></a-light>
        <a-light type="directional" color="#FFFFFF" position="0 10 5" intensity="0.6"></a-light>
        <a-light type="point" intensity="0.9" position="0 10 5" castShadow="true"></a-light>

        <!-- Caméra -->
        <!-- <a-entity>
            <a-camera raycaster="objects: .interactive" far="15" id="camera" fov="100" 
                     look-controls="pointerLockEnabled: true; mouseDrag: true" 
                     wasd-controls="enabled: false" rotation="0 0 0">
                <a-plane id="cursor"
                        position="0 0 -1"
                        width="0.12" 
                        height="0.12" 
                        material="src: ./textures/cursor.png; transparent: true; roughness: 100; metalness: 0;">
                </a-plane>
            </a-camera>
        </a-entity> -->
    </a-scene>

    <div class="info-panel" id="infoPanel"></div>
    <div class="water-level" id="waterLevel"></div>

    <script>
        const waterData = JSON.parse(sessionStorage.getItem('waterData')) || {
            values: [107.34, 107.34, 107.37, 107.39, 107.41, 107.45, 107.48],
            maxValue: 107.48,
            minValue: 107.34,
            stationInfo: { codeBss: "03627X0052/P1", commune: "Gémigny", departement: "Loiret", altitude: "117.6", profondeur: 12 },
            lastMeasurement: 107.48,
        };

        const infoPanel = document.getElementById('infoPanel');
        infoPanel.innerHTML = `
            <h3>${waterData.stationInfo.commune}</h3>
            <p><strong>Département:</strong> ${waterData.stationInfo.departement}</p>
            <p><strong>Code BSS:</strong> ${waterData.stationInfo.codeBss}</p>
            <p><strong>Altitude:</strong> ${waterData.stationInfo.altitude} m</p>
            <p><strong>Profondeur:</strong> ${waterData.stationInfo.profondeur} m</p>
        `;

        const waterElement = document.getElementById('water');
        const waterLevelDisplay = document.getElementById('waterLevel');

        const minHeight = 0;
        const maxHeight = waterData.maxValue + waterData.stationInfo.profondeur;
        const normalizedValue = (waterData.lastMeasurement - minHeight) / (maxHeight - minHeight || 1);
        
        const scaledHeight = normalizedValue * 3;

        waterElement.setAttribute('height', scaledHeight);
        waterElement.setAttribute('position', `0 ${scaledHeight / 2} -6.75`);

        waterLevelDisplay.innerHTML = sessionStorage.getItem('waterData') 
            ? `Niveau actuel: ${waterData.lastMeasurement.toFixed(2)} m (Min: ${waterData.minValue.toFixed(2)} m / Max: ${waterData.maxValue.toFixed(2)} m)`
            : `Aucune mesure, template appliqué <br> Niveau actuel: ${waterData.lastMeasurement.toFixed(2)} m (Min: ${waterData.minValue.toFixed(2)} m / Max: ${waterData.maxValue.toFixed(2)} m)`;
    </script>
</body>
</html>